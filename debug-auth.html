<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auth Debug Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      .output {
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
      }
      .error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .success {
        border-left-color: #28a745;
        background: #d4edda;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Domain Buying Agent - Authentication Debug</h1>

      <div class="section">
        <h3>1. Check Current Auth State</h3>
        <button onclick="checkAuthState()">
          Check LocalStorage & Auth State
        </button>
        <div id="authOutput" class="output"></div>
      </div>

      <div class="section">
        <h3>2. Test Login</h3>
        <input
          type="email"
          id="email"
          placeholder="Email"
          value="test@example.com"
        />
        <input
          type="password"
          id="password"
          placeholder="Password"
          value="password123"
        />
        <button onclick="testLogin()">Login</button>
        <div id="loginOutput" class="output"></div>
      </div>

      <div class="section">
        <h3>3. Test AI Chat API</h3>
        <input
          type="text"
          id="chatMessage"
          placeholder="Test message"
          value="Hello AI"
        />
        <button onclick="testAIChat()">Send AI Message</button>
        <div id="chatOutput" class="output"></div>
      </div>

      <div class="section">
        <h3>4. Test Auth Me Endpoint</h3>
        <button onclick="testAuthMe()">Test /auth/me</button>
        <div id="authMeOutput" class="output"></div>
      </div>
    </div>

    <script>
      const API_URL = "https://regular-innocent-pony.ngrok-free.app/api";

      function log(elementId, message, type = "info") {
        const element = document.getElementById(elementId);
        element.className = `output ${type}`;
        element.innerHTML = `<pre>${JSON.stringify(message, null, 2)}</pre>`;
      }

      function checkAuthState() {
        const token = localStorage.getItem("token");
        const authState = {
          hasToken: !!token,
          token: token ? token.substring(0, 20) + "..." : null,
          tokenLength: token ? token.length : 0,
          localStorage: {
            token: localStorage.getItem("token"),
            user: localStorage.getItem("user"),
          },
        };
        log("authOutput", authState, "info");
      }

      async function testLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          const response = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem("token", data.data.token);
            log(
              "loginOutput",
              {
                success: true,
                message: "Login successful!",
                user: data.data.user,
                tokenSet: !!localStorage.getItem("token"),
              },
              "success"
            );
          } else {
            log(
              "loginOutput",
              {
                success: false,
                error: data.message || "Login failed",
                response: data,
              },
              "error"
            );
          }
        } catch (error) {
          log(
            "loginOutput",
            {
              success: false,
              error: error.message,
              stack: error.stack,
            },
            "error"
          );
        }
      }

      async function testAuthMe() {
        const token = localStorage.getItem("token");

        if (!token) {
          log(
            "authMeOutput",
            { error: "No token found. Please login first." },
            "error"
          );
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/me`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (response.ok) {
            log(
              "authMeOutput",
              {
                success: true,
                user: data.user || data.data?.user,
                response: data,
              },
              "success"
            );
          } else {
            log(
              "authMeOutput",
              {
                success: false,
                status: response.status,
                error: data.message || "Auth check failed",
                response: data,
              },
              "error"
            );
          }
        } catch (error) {
          log(
            "authMeOutput",
            {
              success: false,
              error: error.message,
              stack: error.stack,
            },
            "error"
          );
        }
      }

      async function testAIChat() {
        const token = localStorage.getItem("token");
        const message = document.getElementById("chatMessage").value;

        if (!token) {
          log(
            "chatOutput",
            { error: "No token found. Please login first." },
            "error"
          );
          return;
        }

        try {
          const response = await fetch(`${API_URL}/ai/chat`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message }),
          });

          const data = await response.json();

          if (response.ok) {
            log(
              "chatOutput",
              {
                success: true,
                response: data,
              },
              "success"
            );
          } else {
            log(
              "chatOutput",
              {
                success: false,
                status: response.status,
                error: data.message || "AI chat failed",
                response: data,
              },
              "error"
            );
          }
        } catch (error) {
          log(
            "chatOutput",
            {
              success: false,
              error: error.message,
              stack: error.stack,
            },
            "error"
          );
        }
      }

      // Auto-check auth state on load
      window.onload = function () {
        checkAuthState();
      };
    </script>
  </body>
</html>
